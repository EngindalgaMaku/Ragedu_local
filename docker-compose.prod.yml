# Production Docker Compose Configuration for RAG Education Assistant
# Optimized for production deployment with security and performance considerations

version: "3.8"

services:
  api-gateway:
    build:
      context: .
      dockerfile: Dockerfile.gateway.prod
    container_name: rag-api-gateway-prod
    ports:
      - "80:8080"
      - "443:8443" # HTTPS support
    environment:
      - PDF_PROCESSOR_URL=http://docstrange-service:80
      - DOCUMENT_PROCESSOR_URL=http://document-processing-service:8080
      - MODEL_INFERENCE_URL=http://model-inference-service:8002
      - CHROMADB_URL=http://chromadb-service:8000
      - DOCSTRANGE_URL=http://docstrange-service:80
      - AUTH_SERVICE_URL=http://auth-service:8006
      # Production database configuration
      - DATABASE_PATH=/app/data/rag_assistant.db
      # JWT configuration from environment
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - JWT_ALGORITHM=HS256
      - ACCESS_TOKEN_EXPIRE_MINUTES=15 # Shorter for production
      # Production CORS (restrict to specific domain)
      - CORS_ORIGINS=${CORS_ORIGINS:-https://yourdomain.com}
      - CORS_CREDENTIALS=true
      # Enhanced security
      - DEBUG=false
      - REQUIRE_AUTH=true
      - RATE_LIMIT_RPM=30 # More restrictive
      - RATE_LIMIT_BURST=5
    volumes:
      - database_data:/app/data
      - session_data:/app/sessions
      - markdown_data:/app/data/markdown
      - ssl_certs:/app/ssl # SSL certificates
    depends_on:
      auth-service:
        condition: service_healthy
      docstrange-service:
        condition: service_started
      document-processing-service:
        condition: service_started
      model-inference-service:
        condition: service_started
      chromadb-service:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - rag-network
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: "0.5"
        reservations:
          memory: 512M
          cpus: "0.25"

  auth-service:
    build:
      context: ./services/auth_service
      dockerfile: Dockerfile.prod
    container_name: rag-auth-service-prod
    expose:
      - "8006" # Internal only, not exposed to host
    environment:
      # Server configuration
      - HOST=0.0.0.0
      - PORT=8006
      - DEBUG=false
      # JWT configuration from environment
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - JWT_ALGORITHM=HS256
      - ACCESS_TOKEN_EXPIRE_MINUTES=15
      - REFRESH_TOKEN_EXPIRE_DAYS=1 # Shorter refresh for production
      # Production database
      - DATABASE_PATH=/app/data/rag_assistant.db
      # Production CORS
      - CORS_ORIGINS=${CORS_ORIGINS:-https://yourdomain.com}
      - CORS_CREDENTIALS=true
      # Enhanced rate limiting
      - RATE_LIMIT_RPM=20
      - RATE_LIMIT_BURST=3
      # Security
      - REQUIRE_AUTH=true
      # Logging
      - LOG_LEVEL=WARNING
    volumes:
      - database_data:/app/data
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import requests; requests.get('http://localhost:8006/health')",
        ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped
    networks:
      - rag-network
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.25"
        reservations:
          memory: 256M
          cpus: "0.1"

  docstrange-service:
    build:
      context: ./services/docstrange_service
      dockerfile: Dockerfile.prod
    container_name: rag-docstrange-prod
    expose:
      - "80"
    environment:
      - DOCSTRANGE_API_KEY=${DOCSTRANGE_API_KEY}
      - LOG_LEVEL=WARNING
    restart: unless-stopped
    networks:
      - rag-network
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.2"

  document-processing-service:
    build:
      context: ./services/document_processing_service
      dockerfile: Dockerfile.prod
    container_name: rag-document-processing-prod
    expose:
      - "8080"
    environment:
      - MODEL_INFERENCER_URL=http://model-inference-service:8002
      - CHROMADB_URL=http://chromadb-service:8000
      - CHROMA_SERVICE_URL=http://chromadb-service:8000
      - GROQ_API_KEY=${GROQ_API_KEY}
      - LOG_LEVEL=WARNING
    volumes:
      - session_data:/app/sessions
    restart: unless-stopped
    networks:
      - rag-network
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: "0.5"

  model-inference-service:
    build:
      context: ./services/model_inference_service
      dockerfile: Dockerfile.prod
    container_name: rag-model-inference-prod
    expose:
      - "8002"
    environment:
      - GROQ_API_KEY=${GROQ_API_KEY}
      - OLLAMA_HOST=${OLLAMA_HOST:-http://127.0.0.1:11434}
      - LOG_LEVEL=WARNING
    volumes:
      - ollama_cache:/root/.ollama
    restart: unless-stopped
    networks:
      - rag-network
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: "1.0"

  chromadb-service:
    image: chromadb/chroma:1.3.0
    container_name: rag-chromadb-prod
    expose:
      - "8000"
    volumes:
      - chroma_data:/data
    environment:
      - IS_PERSISTENT=TRUE
      - PERSIST_DIRECTORY=/data
      - ANONYMIZED_TELEMETRY=false
      - ALLOW_RESET=false # Disable reset in production
      - CHROMA_SERVER_HOST=0.0.0.0
      - CHROMA_SERVER_HTTP_PORT=8000
      # Production auth (if ChromaDB supports it)
      - CHROMA_SERVER_AUTH_PROVIDER=basic
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "wget --no-verbose --tries=1 --spider http://localhost:8000/api/v1/heartbeat || exit 1",
        ]
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 60s
    restart: unless-stopped
    networks:
      - rag-network
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: "0.5"

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.prod
    container_name: rag-frontend-prod
    expose:
      - "3000"
    environment:
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-https://yourdomain.com/api}
      - NEXT_PUBLIC_AUTH_URL=${NEXT_PUBLIC_AUTH_URL:-https://yourdomain.com/auth}
      - NODE_ENV=production
      # Production auth settings
      - NEXT_PUBLIC_AUTH_ENABLED=true
      - NEXT_PUBLIC_DEMO_MODE=false # Disable demo mode in production
    depends_on:
      api-gateway:
        condition: service_started
      auth-service:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - rag-network
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.25"

  # Nginx reverse proxy for production
  nginx:
    image: nginx:alpine
    container_name: rag-nginx-prod
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - nginx_logs:/var/log/nginx
    depends_on:
      - api-gateway
      - frontend
    restart: unless-stopped
    networks:
      - rag-network

volumes:
  ollama_cache:
    driver: local
  chroma_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /var/lib/rag-assistant/chroma
  session_data:
    driver: local
  markdown_data:
    driver: local
  database_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /var/lib/rag-assistant/database
  ssl_certs:
    driver: local
  nginx_logs:
    driver: local

networks:
  rag-network:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.name: rag-prod-net
# Production deployment configuration
# Additional considerations:
# - Use Docker Swarm or Kubernetes for orchestration
# - Implement proper logging with centralized log management
# - Set up monitoring with Prometheus/Grafana
# - Configure automated backups
# - Implement proper secrets management
# - Use load balancers for high availability
# - Configure SSL/TLS certificates
# - Implement proper network security
