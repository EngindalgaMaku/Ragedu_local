# Development Override - Hot Reload için
# Kullanım: docker-compose -f docker-compose.yml -f docker-compose.dev.yml up

services:
  # ============================================
  # API GATEWAY - Hot Reload
  # ============================================
  api-gateway:
    volumes:
      # Kod değişikliklerini direkt mount et
      - ./src/api:/app/src/api
      - ./src/database:/app/src/database
      # Mevcut volume'ları koru
      - session_data:/app/sessions
      - markdown_data:/app/data/markdown
      - database_data:/app/data
    # API Gateway main.py içinde uvicorn.run kullanıyor, --reload için uvicorn komutu kullan
    command: python -m uvicorn src.api.main:app --host 0.0.0.0 --port ${API_GATEWAY_PORT:-8000} --reload

  # ============================================
  # DOCUMENT PROCESSING SERVICE - Hot Reload
  # ============================================
  document-processing-service:
    volumes:
      # Kod değişikliklerini direkt mount et
      - ./services/document_processing_service:/app
      - ./src:/app/src
      # Mevcut volume'ları koru
      - session_data:/app/sessions
    command: python -m uvicorn main_new:app --host 0.0.0.0 --port 8080 --reload

  # ============================================
  # AUTH SERVICE - Hot Reload
  # ============================================
  auth-service:
    volumes:
      # Kod değişikliklerini direkt mount et
      - ./services/auth_service:/app
      # Mevcut volume'ları koru
      - database_data:/app/data
      - ./src/database:/app/src_database
      - ./services/auth_service/create_test_user.py:/app/create_test_user.py
      - ./services/auth_service/reset_admin_password.py:/app/reset_admin_password.py
    # init-db.sh'i koru ama reload ekle
    command: >
      sh -c "/app/init-db.sh &&
             python -m uvicorn main:app --host 0.0.0.0 --port $$PORT --reload"

  # ============================================
  # APRAG SERVICE - Hot Reload
  # ============================================
  aprag-service:
    volumes:
      # Kod değişikliklerini direkt mount et
      - ./services/aprag_service:/app
      # Mevcut volume'ları koru
      - database_data:/app/data
      - ./services/auth_service/database/migrations:/app/migrations:ro
    command: python -m uvicorn main:app --host 0.0.0.0 --port ${APRAG_SERVICE_PORT:-8007} --reload

  # ============================================
  # MODEL INFERENCE SERVICE - Hot Reload
  # ============================================
  model-inference-service:
    volumes:
      # Zaten main.py mount edilmiş, tüm servisi mount et
      - ./services/model_inference_service:/app
      # Mevcut volume'ları koru
      - ollama_cache:/root/.ollama
    command: >
      sh -c "echo 'Using external Ollama at ${OLLAMA_HOST}' &&
             uvicorn main:app --host 0.0.0.0 --port ${MODEL_INFERENCE_PORT:-8002} --reload"

  # ============================================
  # EVALUATION SERVICE - Hot Reload
  # ============================================
  evaluation-service:
    volumes:
      # Kod değişikliklerini direkt mount et
      - ./services/evaluation_service:/app
    command: python -m uvicorn main:app --host 0.0.0.0 --port ${EVALUATION_SERVICE_PORT:-8010} --reload

  # ============================================
  # FRONTEND - Hot Reload (Next.js Dev Server)
  # ============================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    volumes:
      # Kod değişikliklerini direkt mount et
      - ./frontend:/app
      # node_modules ve .next container'da kalır (performans için)
      - /app/node_modules
      - /app/.next
    environment:
      # Development mode
      - NODE_ENV=development
      - DOCKER_ENV=true
      # API Gateway configuration for Docker
      - API_GATEWAY_HOST=api-gateway
      - API_GATEWAY_PORT=8000
      # Browser için /api kullan (Next.js rewrites ile api-gateway'e yönlendirilecek)
      # Server-side için internal service name
      - NEXT_PUBLIC_API_URL=/api
      - NEXT_PUBLIC_AUTH_URL=/api
      - API_GATEWAY_INTERNAL_URL=http://api-gateway:8000
      - AUTH_SERVICE_INTERNAL_URL=http://auth-service:8006
    command: npm run dev

  # ============================================
  # HARİCİ SERVİSLER - Değişiklik yok
  # ============================================
  # chromadb-service, marker-api, docstrange-service, reranker-service
  # Bunlar için volume mount gerekmez, olduğu gibi kalır
  # (docker-compose.yml'deki ayarlar kullanılır)

